<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Connections TR</title>

  <style>
    :root{
      --bg:#ffffff; --text:#151515;
      --tile:#f1f1ed; --tileSel:#cfcfca; --border:#b5b5ae; --black:#111111;
      --yellow:#f4de73; --green:#a8c26f; --blue:#b2c7ee; --purple:#b189c8;
      --gap:18px; --tileH:78px; --barH:86px;
      --radius:14px;
      --ease:cubic-bezier(.2,.8,.2,1);
    }

    *{box-sizing:border-box; font-family: ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial;}
    body{margin:0; background:var(--bg); color:var(--text);}
    .wrap{width:min(880px, calc(100vw - 24px)); margin:18px auto;}
    .title{font-size:20px; text-align:center; margin: 6px 0 2px;}
    .msg{font-size:22px; font-weight:900; text-align:center; height:30px; margin: 8px 0 10px;}

    .bars{display:flex; flex-direction:column; gap:14px; margin: 8px 0 16px;}
    .bar{
      height:var(--barH);
      border-radius:var(--radius);
      display:none;
      align-items:center;
      justify-content:center;
      flex-direction:column;
      opacity:1;
      transition: opacity 180ms ease;
    }
    .barTitle{font-weight:900; font-size:22px; line-height:1.05; margin-top:8px;}
    .barWords{font-size:18px; line-height:1.1; margin-bottom:10px;}

    .grid{
      display:grid;
      grid-template-columns: repeat(4, 1fr);
      gap: var(--gap);
      margin-bottom: 14px;
    }

    .tile{
      height:var(--tileH);
      border-radius:var(--radius);
      background:var(--tile);
      border:2px solid var(--border);
      display:flex; align-items:center; justify-content:center;
      font-weight:900; font-size:18px;
      cursor:pointer; user-select:none;
      transition: background .12s ease, border-color .12s ease;
    }
    .tile.selected{ background:var(--tileSel); border:4px solid var(--tileSel); }
    .tile.locked:not(.floating){ display:none; }

    .mist{ text-align:center; margin: 6px 0 10px; font-size:14px; color:#404040;}
    .dots{display:flex; justify-content:center; gap:10px; margin-top:6px;}
    .dot{font-size:22px; line-height:22px; color:#000;}
    .dot.off{color:#e0e0e0;}

    .btnrow{display:flex; justify-content:center; gap:26px; margin-top: 10px; flex-wrap:wrap;}
    .btn{
      width:190px; height:56px; border-radius:18px;
      border:2px solid var(--black); background:#fff;
      font-weight:900; font-size:16px; cursor:pointer;
    }
    .btn:active{background:#f0f0f0}
    .btn:disabled{opacity:.5; cursor:not-allowed}

    /* Flying selected tiles */
    .floating{
      position: fixed !important;
      z-index: 9999;
      margin: 0 !important;
      transition: transform 650ms var(--ease);
    }

    /* Smooth reflow (FLIP) */
    .flip{
      transition: transform 320ms var(--ease);
      will-change: transform;
    }

    /* ===== Mobile polish ===== */
    @media (max-width: 560px){
      .wrap{ width: calc(100vw - 16px); margin: 12px auto; }
      .title{ font-size: 18px; }
      .msg{ font-size: 18px; height: 26px; margin: 6px 0 10px; }

      .grid{
        grid-template-columns: repeat(4, 1fr);
        gap: 10px;
      }

      :root{
        --gap: 10px;
        --tileH: 56px;
        --barH: 72px;
        --radius: 12px;
      }

      .tile{ font-size: 13px; border-radius: var(--radius); }
      .tile.selected{ border-width: 3px; }

      .bar{ border-radius: var(--radius); }
      .barTitle{ font-size: 16px; margin-top: 6px; }
      .barWords{ font-size: 13px; padding: 0 10px; text-wrap: balance; }

      .mist{ font-size: 13px; }
      .dot{ font-size: 20px; }

      .btnrow{ gap: 10px; margin-top: 10px; }
      .btn{
        width: 100%;
        max-width: 520px;
        height: 52px;
        font-size: 16px;
      }
    }

    @media (min-width: 561px) and (max-width: 820px){
      .wrap{ width: calc(100vw - 24px); }
      .grid{ gap: 14px; }
      :root{ --tileH: 68px; --barH: 78px; }
      .tile{ font-size: 15px; }
      .btn{ width: 200px; }
    }
  </style>
</head>

<body>

  <!-- Results Modal (body iÃ§inde olmalÄ±) -->
  <div id="resultsOverlay" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,.35); z-index:10000;">
    <div id="resultsModal" style="width:min(520px, calc(100vw - 24px)); background:#fff; border-radius:22px; margin: 10vh auto; padding: 22px 20px; text-align:center;">
      <div id="resultsTitle" style="font-size:42px; font-weight:900; margin: 4px 0 10px;">Next Time!</div>
      <div style="height:1px; background:#ddd; margin: 14px 0;"></div>

      <div style="display:flex; justify-content:space-around; gap:14px; margin: 8px 0 8px;">
        <div><div id="statTries" style="font-size:34px; font-weight:900;">0</div><div style="color:#666;">Deneme</div></div>
        <div><div id="statMistakes" style="font-size:34px; font-weight:900;">0</div><div style="color:#666;">YanlÄ±ÅŸ</div></div>
        <div><div id="statSolved" style="font-size:34px; font-weight:900;">â€”</div><div style="color:#666;">Durum</div></div>
      </div>

      <div style="height:1px; background:#ddd; margin: 14px 0;"></div>

      <div id="emojiGrid" style="display:inline-grid; grid-template-columns:repeat(4, 22px); gap:8px; margin: 10px 0 18px; font-size:20px; line-height:20px;"></div>

      <button id="shareBtn" class="btn" style="width:min(340px, 100%); height:58px; border-radius:999px; background:#111; color:#fff; border:0;">
        Share Your Results
      </button>

      <div style="margin-top:10px;">
        <button id="closeResults" style="background:transparent; border:0; color:#555; font-weight:700; cursor:pointer;">Close</button>
      </div>
    </div>
  </div>

  <div class="wrap">
    <div class="title">Create four groups of four!</div>
    <div id="msg" class="msg"></div>

    <div id="bars" class="bars"></div>
    <div id="grid" class="grid"></div>

    <div class="mist">Mistakes Remaining:
      <div class="dots" id="dots"></div>
    </div>

    <div class="btnrow">
      <button class="btn" id="shuffle">Shuffle</button>
      <button class="btn" id="submit">Submit</button>
      <button class="btn" id="clear">Deselect All</button>
    </div>
  </div>

<script>
(() => {
  // ---------- State ----------
  let puzzle = null;

  let mistakesLeft = 4;
  let selected = new Set();
  let found = [false,false,false,false];
  let barSlot = 0;
  let animating = false;

  let tries = 0;
  let resultsLog = [];

  // ---------- Emoji mapping ----------
  const EMOJI = { yellow:"ðŸŸ¨", green:"ðŸŸ©", blue:"ðŸŸ¦", purple:"ðŸŸª" };

  // ---------- DOM ----------
  const msgEl = el('#msg');
  const gridEl = el('#grid');
  const barsEl = el('#bars');
  const dotsEl = el('#dots');

  const btnShuffle = el('#shuffle');
  const btnSubmit  = el('#submit');
  const btnClear   = el('#clear');

  // ---------- Load puzzle from JSON ----------
  async function loadPuzzle(url){
    const res = await fetch(url);
    if(!res.ok) throw new Error("Puzzle yÃ¼klenemedi: " + res.status);
    const data = await res.json();

    const palette = {
      yellow: getCss('--yellow'),
      green:  getCss('--green'),
      blue:   getCss('--blue'),
      purple: getCss('--purple'),
    };

    data.groups = data.groups.map(g => ({
      ...g,
      colorKey: g.color,                 // "yellow" -> emoji iÃ§in
      color: palette[g.color] || g.color // hex -> UI iÃ§in
    }));

    return data;
  }

  // ---------- Init ----------
  (async function init(){
    renderBars();
    renderDots();

    puzzle = await loadPuzzle("puzzles/day1.json");
    renderGrid(shuffle([...puzzle.words]));

    btnShuffle.onclick = () => !animating && shuffleOpen();
    btnClear.onclick   = () => !animating && clearSelection();
    btnSubmit.onclick  = () => !animating && submit();
  })();

  // ---------- Rendering ----------
  function renderBars(){
    barsEl.innerHTML = "";
    for(let i=0;i<4;i++){
      const b = document.createElement('div');
      b.className = "bar";
      b.id = `bar-${i}`;
      b.innerHTML = `<div class="barTitle"></div><div class="barWords"></div>`;
      barsEl.appendChild(b);
    }
  }

  function renderDots(){
    dotsEl.innerHTML = "";
    for(let i=0;i<4;i++){
      const d = document.createElement('div');
      d.className = "dot" + (i < mistakesLeft ? "" : " off");
      d.textContent = "â—";
      dotsEl.appendChild(d);
    }
  }

  function renderGrid(words){
    gridEl.innerHTML = "";
    words.forEach((w) => {
      const t = document.createElement('div');
      t.className = "tile";
      t.dataset.word = w;
      t.textContent = w;
      t.onclick = () => {
        if(animating) return;
        if(t.classList.contains('locked')) return;

        if(selected.has(t)){
          selected.delete(t);
          t.classList.remove('selected');
        }else{
          if(selected.size >= 4){ setMsg("En fazla 4 kelime seÃ§ebilirsin."); return; }
          selected.add(t);
          t.classList.add('selected');
        }
      };
      gridEl.appendChild(t);
    });
  }

  // ---------- Helpers ----------
  function setMsg(t){ msgEl.textContent = t || ""; }

  function clearSelection(){
    selected.forEach(t => t.classList.remove('selected'));
    selected.clear();
    setMsg("");
  }

  function shuffleOpen(){
    const open = getOpenTiles();
    const ws = open.map(t => t.dataset.word);
    shuffle(ws);
    open.forEach((t,i)=>{ t.dataset.word = ws[i]; t.textContent = ws[i]; t.classList.remove('selected'); });
    selected.clear();
    setMsg("Shuffled");
  }

  function oneAwayHint(selWords){
    for(let i=0;i<puzzle.groups.length;i++){
      if(found[i]) continue;
      const target = new Set(puzzle.groups[i].items.map(x=>x.toUpperCase()));
      let match = 0;
      for(const w of selWords) if(target.has(w)) match++;
      if(match === 3) return true;
    }
    return false;
  }

  function wordToColorKey(word){
    const W = word.toUpperCase();
    for(const g of puzzle.groups){
      if(g.items.map(x=>x.toUpperCase()).includes(W)){
        return g.colorKey; // "yellow"
      }
    }
    return null;
  }

  // ---------- Game ----------
  function submit(){
    if(selected.size !== 4){ setMsg("4 kelime seÃ§."); return; }
    tries += 1;

    const selWords = [...selected].map(t => t.dataset.word).sort();
    let hit = -1;

    for(let i=0;i<puzzle.groups.length;i++){
      if(found[i]) continue;
      const target = puzzle.groups[i].items.map(x=>x.toUpperCase()).sort();
      if(arrEq(selWords, target)){ hit = i; break; }
    }

    // log every submit (NYT-like)
    const row = selWords.map(w => wordToColorKey(w)).map(k => EMOJI[k] || "â¬œ");
    resultsLog.push(row);

    if(hit === -1){
      const isOneAway = oneAwayHint(selWords);
      mistakesLeft -= 1;
      renderDots();
      setMsg(isOneAway ? "Bir adÄ±m uzakta! (3 doÄŸru, 1 yanlÄ±ÅŸ)" : "Tekrar dene.");

      if(mistakesLeft <= 0){
        setMsg("Bitti.");
        disableAll();
        showResults(false);
      }
      return;
    }

    setMsg("DoÄŸru!");
    animateSolve(hit, puzzle.groups[hit]);
  }

  function disableAll(){
    btnShuffle.disabled = true;
    btnSubmit.disabled  = true;
    btnClear.disabled   = true;
    getAllTiles().forEach(t => t.style.pointerEvents = "none");
  }

  // ---------- NYT-style animation (FLIP + fly) ----------
  async function animateSolve(groupIndex, groupDef){
    animating = true;

    const bar = el(`#bar-${barSlot}`);

    // FIRST positions
    const allTiles = getAllTiles();
    const first = new Map();
    allTiles.forEach(t => first.set(t, rect(t)));

    const selTiles = [...selected].sort((a,b)=> rect(a).left - rect(b).left);

    // Bar placeholder (push grid down)
    bar.style.display = "flex";
    bar.style.background = "#ffffff";
    bar.querySelector('.barTitle').textContent = "";
    bar.querySelector('.barWords').textContent = "";
    bar.style.opacity = "0";

    await nextFrame();

    // Make selected tiles floating at their current position
    const selFixedStart = selTiles.map(t => {
      const r = rect(t);
      t.classList.add('floating');
      t.style.left = r.left + "px";
      t.style.top  = r.top  + "px";
      t.style.width  = r.width + "px";
      t.style.height = r.height + "px";
      t.style.transform = "translate(0px,0px)";
      return r;
    });

    // Remove from grid flow (but visible because floating)
    selTiles.forEach(t => t.classList.add('locked'));
    selected.clear();

    await nextFrame();

    // FLIP remaining tiles
    const remaining = getOpenTiles();
    const last = new Map();
    remaining.forEach(t => last.set(t, rect(t)));

    remaining.forEach(t => {
      const a = first.get(t);
      const b = last.get(t);
      if(!a || !b) return;
      const dx = a.left - b.left;
      const dy = a.top  - b.top;
      t.classList.add('flip');
      t.style.transform = `translate(${dx}px, ${dy}px)`;
    });

    await nextFrame();
    remaining.forEach(t => { t.style.transform = "translate(0px,0px)"; });

    // Fly selected into bar (no scaling)
    const br = rect(bar);
    const gw = selFixedStart[0].width;
    const gh = selFixedStart[0].height;
    const gap = parseFloat(getCss('--gap')) || 18;

    const totalW = 4*gw + 3*gap;
    const startX = br.left + (br.width - totalW)/2;
    const y = br.top + (br.height - gh)/2;

    selTiles.forEach((t,i)=>{
      const r0 = selFixedStart[i];
      const tx = (startX + i*(gw+gap)) - r0.left;
      const ty = y - r0.top;
      requestAnimationFrame(()=> {
        t.style.transform = `translate(${tx}px, ${ty}px)`;
      });
    });

    await sleep(700);

    // finalize
    selTiles.forEach(t => t.remove());

    bar.style.background = groupDef.color;
    bar.querySelector('.barTitle').textContent = groupDef.label.toUpperCase();
    bar.querySelector('.barWords').textContent = groupDef.items.map(x=>x.toUpperCase()).join(", ");
    requestAnimationFrame(()=> bar.style.opacity = "1");

    found[groupIndex] = true;
    barSlot += 1;

    setTimeout(()=> remaining.forEach(t => t.classList.remove('flip')), 350);

    animating = false;

    if(found.every(Boolean)){
      setMsg("Hepsi tamam! ðŸŽ‰");
      disableAll();
      showResults(true);
    }
  }

  // ---------- Results Modal (IIFE iÃ§inde olmalÄ±) ----------
  const overlay = document.getElementById("resultsOverlay");
  const closeBtn = document.getElementById("closeResults");
  const shareBtn = document.getElementById("shareBtn");

  closeBtn.onclick = () => overlay.style.display = "none";
  overlay.addEventListener("click", (e)=>{ if(e.target === overlay) overlay.style.display="none"; });

  function showResults(won){
    document.getElementById("resultsTitle").textContent = won ? "Nice!" : "Next Time!";
    document.getElementById("statTries").textContent = String(tries);
    document.getElementById("statMistakes").textContent = String(4 - mistakesLeft);
    document.getElementById("statSolved").textContent = won ? "Solved" : "Missed";

    const grid = document.getElementById("emojiGrid");
    grid.innerHTML = "";
    const rows = resultsLog.slice(0, 4);
    rows.forEach(r => r.forEach(ch => {
      const cell = document.createElement("div");
      cell.textContent = ch;
      grid.appendChild(cell);
    }));

    overlay.style.display = "block";
  }

  function buildShareText(won){
    const puzzleNo = puzzle?.id ?? 1;
    const header =
`Connections TR
Puzzle #${puzzleNo}
${won ? "âœ… Solved" : "âŒ Missed"} (${4 - mistakesLeft} yanlÄ±ÅŸ, ${tries} deneme)
`;
    const rows = resultsLog.slice(0, 4).map(r => r.join("")).join("\n");
    return header + rows;
  }

  shareBtn.onclick = async () => {
    const won = found.every(Boolean);
    const text = buildShareText(won);

    try{
      if(navigator.share){
        await navigator.share({ text });
      }else{
        await navigator.clipboard.writeText(text);
        shareBtn.textContent = "Copied!";
        setTimeout(()=> shareBtn.textContent = "Share Your Results", 900);
      }
    }catch(err){
      try{
        await navigator.clipboard.writeText(text);
        shareBtn.textContent = "Copied!";
        setTimeout(()=> shareBtn.textContent = "Share Your Results", 900);
      }catch(_){
        alert(text);
      }
    }
  };

  // ---------- Utilities ----------
  function el(q){ return document.querySelector(q); }
  function getAllTiles(){ return [...gridEl.querySelectorAll('.tile')]; }
  function getOpenTiles(){ return getAllTiles().filter(t => !t.classList.contains('locked')); }
  function rect(node){ return node.getBoundingClientRect(); }
  function arrEq(a,b){ return a.length===b.length && a.every((v,i)=>v===b[i]); }

  function shuffle(arr){
    for(let i=arr.length-1;i>0;i--){
      const j = Math.floor(Math.random()*(i+1));
      [arr[i],arr[j]]=[arr[j],arr[i]];
    }
    return arr;
  }

  function getCss(name){
    return getComputedStyle(document.documentElement).getPropertyValue(name).trim();
  }

  function sleep(ms){ return new Promise(r => setTimeout(r, ms)); }
  function nextFrame(){ return new Promise(r => requestAnimationFrame(()=>r())); }

})();
</script>
</body>
</html>
